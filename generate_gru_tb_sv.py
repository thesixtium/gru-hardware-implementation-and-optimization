import math

from float_to_fixed_point import  float_to_fixed_point
import random

def generate_gru_tb_sv(INT_WIDTH=8, FRAC_WIDTH=8, d=64, h=4, NUM_TEST_VECTORS = 100):
    testbench = "`timescale 1ns / 1ps\n"
    testbench += "\n"
    testbench += "module gru_tb;\n"
    testbench += "\n"
    testbench += "// Parameters\n"
    testbench += f"parameter int INT_WIDTH  = {INT_WIDTH};\n"
    testbench += f"parameter int FRAC_WIDTH = {FRAC_WIDTH};\n"
    testbench += "parameter int WIDTH      = INT_WIDTH + FRAC_WIDTH + 1;\n"
    testbench += "parameter real CLK_PERIOD = 10.0;\n"
    testbench += "\n"
    testbench += "// Clock and reset\n"
    testbench += "logic clk;\n"
    testbench += "logic reset;\n"
    testbench += "\n"
    testbench += "// Inputs\n"

    for i in range(d):
        testbench += f"logic signed [WIDTH-1:0] x_{i} = 0;\n"

    testbench += "\n"

    for i in range(h):
        testbench += f"logic signed [WIDTH-1:0] h_{i} = 0;\n"

    testbench += f"\n"
    testbench += f"// Input weights (h×d for each gate)\n"
    input_weights = [
        0.08053853362798691, 0.15270942449569702, 0.11642086505889893, 0.1374807506799698, -0.07342730462551117, -0.1669822633266449, 0.11256489902734756, 0.06027719005942345, -0.2180434763431549, 0.02184499427676201, 0.24509495496749878, -0.0012780175311490893, 0.1561371237039566, 0.042970407754182816, 0.038532331585884094, 0.18106433749198914, -0.031170453876256943, 0.2156798541545868, -0.028184352442622185, 0.1417718082666397, -0.029357003048062325, 0.13195757567882538, 0.09569526463747025, 0.09716377407312393, -0.15725885331630707, 0.11737220734357834, 0.13631832599639893, 0.08918775618076324, 0.22127872705459595, -0.20686325430870056, -0.07274134457111359, 0.10059815645217896, 0.04855671897530556, 0.11931800842285156, 0.11959283798933029, 0.02632271870970726, 0.24873757362365723, 0.07910610735416412, -0.06717374920845032, 0.060143325477838516, 0.14611271023750305, -0.18659698963165283, 0.059477563947439194, -0.09260649979114532, -0.006642831955105066, -0.13815177977085114, -0.19337686896324158, 0.21752306818962097, -0.057389456778764725, -0.09715121239423752, -0.025075851008296013, 0.0010966024128720164, -0.2236155867576599, -0.08480262756347656, 0.06562069058418274, -0.0947333350777626, 0.14965207874774933, -0.10391239821910858, -0.08047530800104141, 0.13279694318771362, -0.1678859144449234, -0.1955755054950714, -0.2012082189321518, 0.13067825138568878, -0.11369004845619202, -0.10013100504875183, 0.18684536218643188, 0.1467503160238266, 0.01987226866185665, 0.060721080750226974, 0.05131698399782181, 0.03216760978102684, 0.03914652764797211, 0.036223623901605606, -0.029508138075470924, -0.001214575837366283, 0.045634906738996506, 0.1094088926911354, -0.16551527380943298, 0.03328990191221237, -0.0006534465937875211, -0.0034939281176775694, -0.013465105555951595, -0.07832708954811096, -0.015407086350023746, 0.04462067037820816, -0.06242880970239639, -0.0936996191740036, 0.0012508750660344958, 0.1818871647119522, -0.2005975842475891, -0.19285523891448975, 0.20946064591407776, 0.06371066719293594, 0.014211764559149742, -0.0023178942501544952, -0.11998637020587921, -0.011247401125729084, -0.018316611647605896, 0.014698551036417484, 0.06130180507898331, 0.035469524562358856, 0.04910699278116226, 0.12531553208827972, 0.07542609423398972, 0.0015262176748365164, -0.010505137965083122, 0.06331164389848709, 0.024084022268652916, 0.04928320273756981, -0.011985584162175655, -0.03481509909033775, -0.0357077457010746, -0.20738908648490906, 0.11944780498743057, 0.16666662693023682, -0.04873296245932579, -0.0960584208369255, -0.0937364473938942, -0.1060413047671318, -0.0609845295548439, 0.1986461579799652, 0.11644777655601501, -0.1285550445318222, -0.03278869390487671, -0.053103137761354446, 0.16812515258789062, -0.09476054459810257, -0.08936720341444016, -0.06207653880119324, -0.21284513175487518, -0.13197855651378632, -0.07269477844238281, -0.03376352787017822, 0.02296566404402256, -0.1586546152830124, -0.04277731105685234, -0.04093701019883156, -0.04643630236387253, -0.2280806005001068, -0.036178234964609146, 0.05423273518681526, -0.042835578322410583, 0.08578512072563171, -0.16213324666023254, 0.22399604320526123, 0.01173214428126812, 0.07404104620218277, 0.05441167950630188, -0.07042718678712845, 0.1169913113117218, 0.20694926381111145, 0.10549429804086685, 0.03447109833359718, -0.015389576554298401, -0.20538698136806488, -0.058823976665735245, 0.23565678298473358, -0.09384830296039581, -0.09275000542402267, 0.010558669455349445, 0.0896683782339096, -0.045704253017902374, -0.0528670959174633, 0.011955192312598228, 0.0413711741566658, 0.12517708539962769, -0.0013178323861211538, 0.11120855808258057, -0.05209265649318695, 0.1155916228890419, -0.012545420788228512, 0.04392971470952034, 0.06181327998638153, 0.04871145635843277, 0.025344019755721092, 0.05032568424940109, 0.042311474680900574, -0.1191541850566864, 0.08497044444084167, 0.0800519734621048, 0.05573701113462448, -0.21374885737895966, 0.07336469739675522, 0.04894023388624191, -0.1592734158039093, -0.11745646595954895, -0.10319438576698303, 0.14977917075157166, 0.06855031847953796, 0.1553882360458374, 0.27570125460624695, -0.008336815051734447, 0.2475666105747223, 0.00048509269254282117, 0.19772885739803314, -0.1796521246433258, 0.0404035709798336, 0.02978375554084778, -0.07486646622419357, -0.028125058859586716, 0.16278889775276184, -0.11560052633285522, -0.021521927788853645, -0.12636663019657135, -0.042329154908657074, -0.05500733479857445, -0.028240779414772987, 0.009454150684177876, 0.04184037074446678, -0.08680128306150436, 0.12689635157585144, -0.05073263496160507, 0.050105705857276917, 0.0824291780591011, 0.05320735275745392, 0.2073250263929367, 0.04548247903585434, -0.029242830350995064, -0.07551591098308563, 0.044203002005815506, 0.03725619241595268, -0.13276280462741852, 0.2587420642375946, 0.13259579241275787, -0.15384818613529205, 0.06267884373664856, 0.03595341369509697, 0.04587908089160919, -0.21909105777740479, 0.09593972563743591, 0.014074861072003841, -0.00462611299008131, 0.14580585062503815, -0.1632869839668274, 0.0236529354006052, -0.08599667251110077, -0.06975455582141876, 0.1932287961244583, -0.09030862152576447, -0.052639178931713104, -0.03756767511367798, -0.10946227610111237, -0.09345388412475586, -0.1019468829035759, -0.11397924274206161, -0.06493233144283295, -0.22643381357192993, -0.10632064938545227, 0.12196523696184158, -0.13718047738075256, -0.09720358997583389, -0.0938032791018486, -0.08072572201490402, -0.18642745912075043, -0.07796791940927505, -0.013659748248755932, -0.04919527471065521, -0.036279428750276566, -0.09674031287431717, 0.0049152616411447525, 0.09021943807601929, -0.11185383051633835, -0.15908001363277435, -0.2304387390613556, -0.08830765634775162, -0.20500551164150238, -0.06629160791635513, -0.036738861352205276, 0.09001148492097855, 0.024550119414925575, -0.036810677498579025, -0.1218547597527504, -0.09144945442676544, -0.11876603960990906, -0.1460801064968109, -0.0346563383936882, 0.10469617694616318, 0.2644590139389038, 0.14645181596279144, -0.21818290650844574, -0.17646031081676483, 0.014247450977563858, -0.21839992702007294, 0.18580664694309235, -0.009063049219548702, 0.17759057879447937, -0.12054367363452911, -0.20314781367778778, -0.17703737318515778, -0.1189192607998848, -0.12932589650154114, -0.19682039320468903, -0.16655994951725006, -0.10733281821012497, 0.06723177433013916, 0.0467974953353405, -0.1128430962562561, -0.01600276678800583, -0.08628291636705399, -0.24132931232452393, -0.04109415039420128, -0.041852500289678574, -0.029887279495596886, 0.0005766202230006456, -0.052883800119161606, 0.16325373947620392, -0.09776364266872406, 0.22868163883686066, 0.11058974266052246, 0.24037131667137146, 0.20058311522006989, 0.07838422805070877, -0.21693097054958344, 0.12825018167495728, 0.43285971879959106, 0.32343238592147827, 0.3411940336227417, 0.40286844968795776, 0.35952478647232056, 0.04112856835126877, 0.04424891993403435, 0.05225727707147598, -0.0303880013525486, -0.033699385821819305, -0.14441491663455963, 0.19465969502925873, -0.22927169501781464, -0.1778869926929474, -0.06490446627140045, -0.005329693201929331, -0.036653898656368256, -0.1399800330400467, -0.04095122590661049, -0.12131980806589127, -0.12561286985874176, 0.14441613852977753, -0.1571449488401413, 0.030233122408390045, -0.19559471309185028, -0.038993991911411285, 0.005284997168928385, 0.08052828907966614, 0.05021928250789642, -0.01958123780786991, -0.09528838098049164, -0.01861044578254223, 0.09063927084207535, 0.01954064518213272, -0.11520262807607651, -0.058373838663101196, -0.21673190593719482, -0.014265726320445538, -0.2497304230928421, -0.06310304999351501, 0.12165217846632004, -0.12307317554950714, -0.1831587851047516, -0.27217867970466614, 0.15964369475841522, -0.0794631615281105, -0.031288374215364456, 0.013389433734118938, -0.08770706504583359, 0.03233278915286064, -0.08400662988424301, -0.03594239056110382, 0.119273841381073, 0.05942908301949501, 0.04889270290732384, 0.04165143519639969, 0.04341324791312218, -0.06724168360233307, -0.080216184258461, 0.05718424543738365, 0.0006428600754588842, 0.04313737154006958, -0.141140416264534, -0.13125033676624298, -0.07213504612445831, 0.23305706679821014, 0.15803666412830353, -0.07794699817895889, 0.14145535230636597, 0.18229396641254425, -0.04810355603694916, 0.2922430634498596, -0.07475756108760834, 0.16386745870113373, 0.03842916339635849, -0.2069307267665863, 0.29316240549087524, 0.3368857800960541, 0.1977434754371643, 0.2409093976020813, -0.005846783053129911, 0.0031935658771544695, 0.07264390587806702, -0.07049862295389175, -0.2049657106399536, -0.08484838157892227, 0.15381227433681488, -0.005594081245362759, -0.01105474028736353, -0.04553874582052231, -0.16660520434379578, 0.271525502204895, -0.009946458041667938, -0.1590316742658615, 0.07880272716283798, -0.1727864146232605, -0.13278304040431976, 0.1907089501619339, 0.16496802866458893, -0.16383764147758484, 0.1503763645887375, 0.013120404444634914, 0.07888108491897583, 0.20964699983596802, 0.25121498107910156, -0.019272539764642715, 0.0612478069961071, -0.24445417523384094, -0.024698153138160706, 0.12463720887899399, -0.09572164714336395, 0.27711576223373413, 0.0662749782204628, 0.13307422399520874, -0.11501030623912811, -0.20469965040683746, 0.2497524917125702, -0.18699415028095245, -0.11616414040327072, 0.12574568390846252, -0.018169594928622246, 0.13303031027317047, -0.42602068185806274, -0.05727513134479523, 0.03738568350672722, -0.15108127892017365, -0.0700012817978859, -0.1601136326789856, -0.1855894774198532, -0.05718306452035904, -0.38293376564979553, -0.46101880073547363, -0.4884014427661896, -0.3387851119041443, -0.3512689173221588, 0.09729878604412079, -0.050495389848947525, 0.19388480484485626, 0.2648167908191681, -0.21350261569023132, 0.050925225019454956, -0.15865924954414368, -0.38811782002449036, -0.13348780572414398, 0.15463536977767944, 0.18662512302398682, -0.17450448870658875, 0.18925054371356964, -0.0005939480033703148, 0.038671381771564484, -0.09380123764276505, 0.03804120421409607, 0.2296529859304428, -0.1096356213092804, -0.09141553193330765, 0.24739642441272736, -0.10467112064361572, 0.2228873372077942, 0.10760907828807831, 0.13528873026371002, -0.05562737584114075, 0.1769944429397583, 0.2665763795375824, 0.1740855723619461, 0.09352891147136688, -0.15939448773860931, -0.09610501676797867, -0.3605068027973175, -0.19859912991523743, 0.23660466074943542, 0.002157502807676792, 0.20016086101531982, -0.26594558358192444, -0.009024047292768955, -0.25792425870895386, -0.27483615279197693, -0.28506338596343994, -0.1463971585035324, 0.03757321462035179, 0.5472831726074219, -0.14714516699314117, -0.024610253050923347, -0.1622779667377472, -0.24029184877872467, 0.36541423201560974, -0.27176493406295776, 0.08660886436700821, 0.2772635817527771, 0.04401379078626633, 0.5680912733078003, 0.07192155718803406, 0.5794101357460022, 0.09233375638723373, -0.24039600789546967, 0.27741539478302, 0.37652164697647095, -0.2403569519519806, -0.11079109460115433, 0.060478661209344864, -0.05053836852312088, 0.1384868621826172, -0.03790925443172455, -0.06890038400888443, -0.2186364084482193, -0.11864786595106125, -0.06803027540445328, 0.14682289958000183, 0.06803012639284134, 0.2166449874639511, -0.058352794498205185, 0.11239166557788849, 0.11123311519622803, 0.04752080887556076, -0.04061635211110115, 0.17063221335411072, 0.24905282258987427, 0.13851693272590637, -0.024672944098711014, 0.04571278765797615, 0.17355221509933472, 0.039090175181627274, 0.015096746385097504, -0.04260150343179703, -0.23127810657024384, 0.052711181342601776, 0.12185034900903702, 0.01066860556602478, 0.15469971299171448, 0.1321335732936859, -0.03605513274669647, -0.14100529253482819, -0.1952538788318634, -0.0960267037153244, -0.10818586498498917, -0.3236762285232544, 0.055653270334005356, -0.017335638403892517, -0.04401925951242447, 0.21379660069942474, -0.16480594873428345, 0.13561591506004333, 0.0014337077736854553, -0.12313032150268555, -0.1460523009300232, 0.16768686473369598, 0.0686502754688263, 0.295488178730011, -0.0008897167863324285, 0.06019233539700508, -0.07316049933433533, -0.18013739585876465, -0.20649994909763336, -0.10261614620685577, 0.23048853874206543, -0.07342608273029327, 0.23784583806991577, -0.05433885380625725, -0.27281081676483154, -0.42974838614463806, -0.49660709500312805, 0.10882294923067093, 0.1984093189239502, 0.06867160648107529, 0.04453881084918976, 0.003061695722863078, 0.030188346281647682, 0.1505460888147354, -0.19877047836780548, -0.16191041469573975, 0.0047941007651388645, 0.25210949778556824, 0.12984667718410492, -0.26341500878334045, -0.1603514701128006, 0.17000123858451843, -0.0519770085811615, 0.20036965608596802, -0.2361966073513031, 0.1159365251660347, 0.2832818925380707, -0.17105023562908173, -0.1500416100025177, -0.23389886319637299, 0.1381976455450058, 0.32749608159065247, 0.12096478790044785, -0.11982177942991257, -0.10146074742078781, -0.12999115884304047, -0.08420475572347641, -0.19716237485408783, -0.05541275441646576, -0.19977998733520508, 0.1531934142112732, -0.06409922242164612, -0.12676820158958435, 0.16175952553749084, -0.2856632173061371, 0.04084291681647301, -0.007042907178401947, -0.12694787979125977, 0.1781517118215561, 0.08978286385536194, 0.2341294139623642, 0.20091119408607483, 0.012067367322742939, 0.22902566194534302, 0.0637262836098671, -0.05328938737511635, -0.18256230652332306, -0.036160048097372055, -0.10478144884109497, 0.11381573975086212, 0.17000146210193634, 0.0957321971654892, -0.23830291628837585, 0.2997368574142456, 0.15058286488056183, -0.05998280271887779, -0.01760849915444851, 0.21780121326446533, -0.2673472762107849, -0.012551452964544296, -0.10737518966197968, -0.09364887326955795, 0.08947986364364624, 0.12340565770864487, -0.046386703848838806, 0.048482466489076614, 0.2003881335258484, 0.08702293783426285, -0.2871640622615814, 0.09038249403238297, -0.3720015287399292, -0.049935001879930496, -0.0045344028621912, -0.11002694815397263, -0.21695716679096222, 0.09847328811883926, -0.013599862344563007, -0.3372902274131775, 0.12919321656227112, 0.14498473703861237, -0.371064156293869, -0.2623305916786194, 0.206349179148674, -0.19567647576332092, 0.08447887003421783, -0.18600232899188995, 0.09889867901802063, -0.1685178428888321, 0.29259490966796875, -0.047258760780096054, 0.17574071884155273, 0.27702024579048157, -0.03881032019853592, 0.0011355490423738956, 0.33976125717163086, -0.2560778856277466, -0.23857440054416656, -0.11426117271184921, 0.3153216242790222, 0.26118865609169006, -0.16200831532478333, -0.3294092118740082, 0.1384376734495163, -0.018719825893640518, -0.2359333336353302, 0.04345565661787987, -0.08038224279880524, 0.1503550112247467, -0.05543969199061394, -0.05643687769770622, -0.09418079257011414, -0.0036053648218512535, -0.2362469583749771, -0.09914521127939224, -0.25397953391075134, 0.21330459415912628, -0.03133557736873627, -0.11121024191379547, -0.10687007755041122, 0.22515542805194855, 0.24135923385620117, 0.3031965494155884, 0.47402212023735046, 0.31798574328422546, 0.5457519888877869, 0.40475112199783325, -0.35064083337783813, 0.25554120540618896, 0.01888640969991684, 0.27712908387184143, -0.3192327916622162, 0.06906360387802124, -0.2801852524280548, 0.15477146208286285, -0.4307692050933838, -0.35132649540901184, 0.2893657386302948, -0.3508997857570648, -0.3403928577899933, 0.14505542814731598, 0.12359770387411118, 0.12426406145095825, 0.3322887420654297, -0.06949200481176376, -0.0013568704016506672, 0.3966636061668396, -0.0606149360537529, -0.23614230751991272, -0.08854746073484421, -0.11395401507616043, -0.30979645252227783, -0.05708632618188858, -0.2523323595523834, -0.3128976821899414, 0.41286835074424744, 0.1383158266544342, 0.025029415264725685, 0.22904734313488007, 0.1347096562385559, -0.06194617971777916, 0.22359459102153778, 0.11254151910543442, -0.2664780616760254, -0.32143303751945496, 0.1342138946056366, -0.010899674147367477, -0.3727233111858368, -0.3251086175441742, 0.2552630603313446, 0.023118136450648308, 0.08659122884273529, 0.3888419568538666, -0.03520714491605759, 0.3131086826324463, 0.037116602063179016, -0.03630875423550606, -0.1684923619031906, 0.17488247156143188, -0.07758405059576035, -0.315962553024292, 0.38376039266586304, 0.059219542890787125, -0.18113353848457336, 0.17765867710113525, -0.14893470704555511, 0.3462870717048645, 0.3409862220287323, 0.08129491657018661, 0.02790561318397522, 0.2963590919971466]

    input_count = 0
    for i in range(h):
        for j in range(d):
            testbench += f"logic signed [WIDTH-1:0] w_ir_{i}_{j} = 'b{float_to_fixed_point(input_weights[input_count], INT_WIDTH, FRAC_WIDTH)};\n"
            input_count += 1

    testbench += f"\n"
    for i in range(h):
        for j in range(d):
            testbench += f"logic signed [WIDTH-1:0] w_iz_{i}_{j} = 'b{float_to_fixed_point(input_weights[input_count], INT_WIDTH, FRAC_WIDTH)};\n"
            input_count += 1

    testbench += f"\n"
    for i in range(h):
        for j in range(d):
            testbench += f"logic signed [WIDTH-1:0] w_in_{i}_{j} = 'b{float_to_fixed_point(input_weights[input_count], INT_WIDTH, FRAC_WIDTH)};\n"
            input_count += 1

    testbench += f"\n"
    testbench += f"// Recurrent weights (h×h for each gate)\n"
    recurrent_weights = [
        0.0139,  0.0377,  0.0610, -0.1597,
        0.2737,  0.2944,  0.2919, -0.2886,
        0.2481,  0.2809, -0.1272, -0.1529,
        0.1221,  0.1561,  0.3518, -0.2372,
        0.2147,  0.1118, -0.0818,  0.1274,
        0.4074, -0.3818,  0.0065,  0.2801,
        0.2123,  0.0052, -0.4900,  0.4447,
        0.3739,  0.1362, -0.2939,  0.6478,
        -0.0398, -0.0751,  0.1421, -0.2018,
        -0.1765, -0.0241,  0.7325, -0.3669,
        -0.0399,  0.4253,  0.6215, -0.4363,
        -0.1627, -0.3004, -0.2050,  0.3073]
    recurrent_count = 0

    for i in range(h):
        for j in range(h):
            testbench += f"logic signed [WIDTH-1:0] w_hr_{i}_{j} = 'b{float_to_fixed_point(recurrent_weights[recurrent_count], INT_WIDTH, FRAC_WIDTH)};\n"
            recurrent_count += 1

    testbench += f"\n"
    for i in range(h):
        for j in range(h):
            testbench += f"logic signed [WIDTH-1:0] w_hz_{i}_{j} = 'b{float_to_fixed_point(recurrent_weights[recurrent_count], INT_WIDTH, FRAC_WIDTH)};\n"
            recurrent_count += 1

    testbench += f"\n"
    for i in range(h):
        for j in range(h):
            testbench += f"logic signed [WIDTH-1:0] w_hn_{i}_{j} = 'b{float_to_fixed_point(recurrent_weights[recurrent_count], INT_WIDTH, FRAC_WIDTH)};\n"
            recurrent_count += 1

    testbench += f"\n"
    testbench += f"// Biases (h for each gate type)\n"
    bias_count = 0
    bias_weights = [
        0.0225,  0.2605,  0.4639,  0.1595,  0.1898,  0.1342,
        0.4927, -0.0117,  0.3322,  0.0567,  0.4395,  0.0744,
        0.0715,  0.3055,  0.2149,  0.4094,  0.2042,  0.2859,
        0.1559,  0.8078,  0.0949,  0.5933,  0.2285, -0.4838]

    for gate in ['ir', 'iz', 'in', 'hr', 'hz', 'hn']:
        for i in range(h):
            testbench += f"logic signed [WIDTH-1:0] b_{gate}_{i} = 'b{float_to_fixed_point(bias_weights[bias_count], INT_WIDTH, FRAC_WIDTH)};\n"
            bias_count += 1
        testbench += "\n"

    testbench += f"// Outputs (h={h})\n"
    for i in range(h):
        testbench += f"logic signed [WIDTH-1:0]  y_{i} = 0;\n"

    testbench += """
gru #(
        .INT_WIDTH(INT_WIDTH),
        .FRAC_WIDTH(FRAC_WIDTH)
    ) gru_inst (
        .clk(clk),
        .reset(reset),
        // Input features (d=64)
        """

    testbench += "\t\n"
    for i in range(d):
        testbench += f".x_{i}(x_{i}), "

    testbench += "\t\n"
    for i in range(h):
        testbench += f".h_{i}(h_{i}), "

    testbench += f"\t\n"
    for i in range(h):
        for j in range(d):
            testbench += f".w_ir_{i}_{j}(w_ir_{i}_{j}), "

    testbench += f"\t\n"
    for i in range(h):
        for j in range(d):
            testbench += f".w_iz_{i}_{j}(w_iz_{i}_{j}), "

    testbench += f"\n"
    for i in range(h):
        for j in range(d):
            testbench += f".w_in_{i}_{j}(w_in_{i}_{j}), "

    testbench += f"\n"
    for i in range(h):
        for j in range(h):
            testbench += f".w_hr_{i}_{j}(w_hr_{i}_{j}), "

    testbench += f"\n"
    for i in range(h):
        for j in range(h):
            testbench += f".w_hz_{i}_{j}(w_hz_{i}_{j}), "

    testbench += f"\n"
    for i in range(h):
        for j in range(h):
            testbench += f".w_hn_{i}_{j}(w_hn_{i}_{j}), "

    testbench += f"\n"
    for gate in ['ir', 'iz', 'in', 'hr', 'hz', 'hn']:
        for i in range(h):
            testbench += f".b_{gate}_{i}(b_{gate}_{i}), "
        testbench += "\n"

    for i in range(h):
        if i == h-1:
            testbench += f".y_{i}(y_{i})"
        else:
            testbench += f".y_{i}(y_{i}), "

    testbench += "\n);"

    testbench += "\n"
    testbench += f"""
    initial begin
        clk = 0;
        forever #5 clk = ~clk;
    end
    
    initial begin
        // Open file for writing (overwrite existing)
        integer fd;
        fd = $fopen("../../../../../output_d{d}_h{h}_int{INT_WIDTH}_frac{FRAC_WIDTH}.txt", "w+");
        if (fd == 0) begin
            $display("ERROR: Failed to open file!");
            $finish;
        end
    """

    for n in range (NUM_TEST_VECTORS):

        for i in range(d):
            testbench += f"    x_{i} = 'b{float_to_fixed_point(math.sin((n+2)*(i+1)), INT_WIDTH, FRAC_WIDTH)};\n"

        testbench += "\n"

        for i in range(h):
            testbench += f"    h_{i} = 'b{float_to_fixed_point(math.sin((n+1)*(i+0.5)), INT_WIDTH, FRAC_WIDTH)};\n"

        testbench += "    #20;\n"
        testbench += f"    $fdisplay(fd, \"{''.join([f'%0{INT_WIDTH+FRAC_WIDTH}b ' for _ in range(h)])[:-1]}\", {''.join([f'y_{g}, ' for g in range(h)])[:-2]});\n\n"

    testbench += "    $fclose(fd);    \n$finish;\n    end"



    return testbench + "\nendmodule"


# Example usage:
if __name__ == "__main__":
    # Generate testbench for d=64, h=4
    tb_code = generate_gru_tb_sv(INT_WIDTH=8, FRAC_WIDTH=8, d=64, h=4)
    print(tb_code)
